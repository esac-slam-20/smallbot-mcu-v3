# 通讯协议

## 基础格式

```
0x55 <CMD> <LEN> <DAT> <CRC> 0xAA
```

其中：
- CMD: 1 Byte, 指示当前命令
- LEN: 1 Byte, 指示接下来的数据长度
- DAT: 数据，长度由 LEN 规定。
- CRC: 2 Byte, 是从 CMD 到 DAT 最后一位的CRC校验和。

所有的数据都是小端序，即低字节放在前面：0x0123 表示为 0x23 0x01。

CRC校验和暂时不做，请保证其为 0x00 0x00。

所有的下发命令收到后都会回复ACK或NACK，请在长时间未收到ACK的情况下尝试重新发送。

## 下发命令

### 0x10 设置电机速度

数据格式：

```
<SPD1> <SPD2> <SPD3> <SPD4>
```

其中：
- SPDx: 电机转速，单位rpm，数据类型为 int16_t

> 示例：
> 
> 电机1转速为 2000rpm，电机2转速为-2000rpm，电机3转速为0，电机4转速为0
>
> ```
> 0x55 0x10 0x08 0xD0 0x07 0x30 0xF8 0x00 0x00 0x00 0x00 0x00 0x00 0xAA
> ```
>

### 0x11 读取编码器数值

无附加数据。

收到此命令后，发送0x80 ODOM帧，且不会返回ACK帧。

### 0x12 读取电池电压值

无附加数据。

收到此命令后，发送0x81 BATT帧，且不会返回ACK帧。

### 0x20 设置编码器参数

数据格式：

```
<TICK>
```

其中:
- TICK: 电机旋转一圈，编码器增量大小。数据类型为uint16_t, 单位为 tick

### 0x21 设置PID参数

数据格式：

```
<PRO> <INT> <DIF>
```

其中：

- PRO: PID 控制中的比例系数，数据类型为 float
- INT: PID 控制中的积分系数，数据类型为 float
- DIF: PID 控制中的微分系数，数据类型为 float

### 0x2E 保存设置的参数

无附加数据。

收到此命令后，会将参数写入存储器中，下次开机启动会自动载入。

### 0x2F 忽略设置的参数

无附加数据。

收到此命令后，会将参数从存储器中读取，覆盖掉之前设置但未保存的参数。

## 上发命令

### 0x00 ACK 命令已收到

无附加数据。

收到此命令，意味着小车已经收到了下发的命令。若长时间未收到此命令，请尝试重发上一次的数据。

### 0x01 NACK 命令接收错误

无附加数据。

收到此命令，意味着小车虽然收到了下发的命令，但无法执行。可能的原因是CRC校验和出错，请尝试重发。

### 0x02 INVALID ARGS 命令参数错误

无附加数据。

收到此命令，意味着小车虽然收到了下发的命令，但无法执行。可能的原因是命令参数长度出错，请检查命令是否正确，或尝试重发。

### 0x80 ODOM 小车编码器数值

数据格式：

```
<ODOM1> <ODOM2> <ODOM3> <ODOM4>
```

其中：
- ODOMx: 编码器数据。数据类型为int32_t, 单位为Tick

### 0x81 BATT 电池电压数值

数据格式：

```
<VOLTAGE>
```

其中：
- VOLTAGE: 电压数据。数据类型为uint16_t, 单位为mv
